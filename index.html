<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FOOTSTEP-ALT v1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;color:#fff;font-family:sans-serif;}
video,canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}
#topBar{
  position:fixed;top:0;left:0;right:0;
  background:rgba(0,0,0,.75);padding:6px;text-align:center;
}
#panel{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(0,0,0,.85);padding:8px;
}
button,select{font-size:14px;margin:2px;}
details{margin-top:6px;}
#hud{font-size:12px;opacity:.8;}
</style>
</head>

<body>

<div id="topBar">
  <b>FOOTSTEP-ALT</b><br>
  <small>Human-in-the-Loop Ankle Exercise Logger</small>
</div>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="panel">
  <button id="startBtn">▶ 開始</button>
  <select id="cameraSel">
    <option value="environment">背面</option>
    <option value="user">前面</option>
  </select>
  <button id="hudBtn">HUD</button><br>

  足：<span id="side">LEFT</span>　
  左：<span id="leftCount">0</span>　
  右：<span id="rightCount">0</span>

  <details>
    <summary>ログ / CSV</summary>
    <div id="logInfo"></div>
    <button id="csvBtn">CSV出力</button>
    <div id="hud" style="display:none"></div>
  </details>
</div>

<script>
/* ===== (1) DOM参照：ここだけ追加（必須）===== */
const startBtn = document.getElementById("startBtn");
const cameraSel = document.getElementById("cameraSel");
const hudBtn = document.getElementById("hudBtn");
const csvBtn = document.getElementById("csvBtn");

const side = document.getElementById("side");
const leftCountSpan = document.getElementById("leftCount");
const rightCountSpan = document.getElementById("rightCount");

const logInfo = document.getElementById("logInfo");
const hud = document.getElementById("hud");

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

/* ===== 基本要素 ===== */
let model, stream=null, running=false;
let currentSide="LEFT", leftCount=0, rightCount=0;
let phase="BACK";
let lastSize=null, minSize=Infinity, maxSize=0;
let hudOn=false;

/* ===== 時刻・ログ ===== */
let sessionStart=null, sessionEnd=null;
const STORAGE_KEY="FOOTSTEP_ALT_LOGS";

/* ===== カメラ制御 ===== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:cameraSel.value}
  });
  video.srcObject = stream;
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  model = await cocoSsd.load();
  running = true;
  sessionStart = new Date();
  startBtn.textContent="■ 停止";
  detect();
}

function stopCamera(){
  running=false;
  sessionEnd = new Date();
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  startBtn.textContent="▶ 開始";
  saveSession();
}

/* ===== 足サイズ ===== */
function getFootSize(person){
  return person.bbox[3]*0.33; // 元のまま
}

/* ===== メイン検出 ===== */
async function detect(){
  if(!running) return;

  const preds = await model.detect(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* ===== (2) personが取れないときのフォールバック：ここだけ変更 ===== */
  // person があればそれを使う。なければ「最大面積bbox」を使う。
  const target =
    preds.find(p=>p.class==="person") ||
    (preds.length ? preds.slice().sort((a,b)=> (b.bbox[2]*b.bbox[3]) - (a.bbox[2]*a.bbox[3]))[0] : null);

  if(target){
    const size = getFootSize(target);

    minSize=Math.min(minSize,size);
    maxSize=Math.max(maxSize,size);
    const range=maxSize-minSize;

    if(range>20){
      const frontTh=minSize+range*0.6;
      const backTh =minSize+range*0.4;

      if(phase==="BACK" && size>frontTh){
        phase="FRONT";
      }
      else if(phase==="FRONT" && size<backTh){
        phase="BACK";
        if(currentSide==="LEFT"){leftCount++;currentSide="RIGHT";}
        else{rightCount++;currentSide="LEFT";}
        minSize=size; maxSize=size;
      }
    }

    if(hudOn){
      hud.innerHTML=
        `preds:${preds.length}<br>`+
        `target:${target.class} score:${(target.score??0).toFixed(2)}<br>`+
        `bboxH:${target.bbox[3].toFixed(1)}<br>`+
        `min:${minSize.toFixed(1)} max:${maxSize.toFixed(1)}<br>`+
        `phase:${phase}`;
    }
  }

  side.textContent=currentSide;
  leftCountSpan.textContent=leftCount;
  rightCountSpan.textContent=rightCount;

  requestAnimationFrame(detect);
}

/* ===== 保存 ===== */
function saveSession(){
  if(!sessionStart||!sessionEnd) return;
  const total=leftCount+rightCount;
  const minutes=(sessionEnd-sessionStart)/60000;
  const speed=minutes>0?(total/minutes):0;

  const record={
    date:sessionStart.toISOString().slice(0,10),
    start:sessionStart.toLocaleTimeString(),
    end:sessionEnd.toLocaleTimeString(),
    total, speed:speed.toFixed(2)
  };

  let logs=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  logs.push(record);

  // 最大7日分
  const cutoff=new Date();
  cutoff.setDate(cutoff.getDate()-6);
  logs=logs.filter(l=>new Date(l.date)>=cutoff);

  localStorage.setItem(STORAGE_KEY,JSON.stringify(logs));
  renderLogs();
}

/* ===== CSV ===== */
function exportCSV(){
  const logs=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  let csv="date,start,end,total,avg_per_min\n";
  logs.forEach(l=>{
    csv+=`${l.date},${l.start},${l.end},${l.total},${l.speed}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="footstep_alt.csv";
  a.click();
}

/* ===== 表示 ===== */
function renderLogs(){
  const logs=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  logInfo.innerHTML=logs.map(l=>
    `${l.date} ${l.start}-${l.end} 合計:${l.total} 平均:${l.speed}/分`
  ).join("<br>");
}

/* ===== UI ===== */
startBtn.onclick=()=>{running?stopCamera():startCamera();};
hudBtn.onclick=()=>{hudOn=!hudOn;hud.style.display=hudOn?"block":"none";};
csvBtn.onclick=exportCSV;

renderLogs();
</script>

</body>
</html>
