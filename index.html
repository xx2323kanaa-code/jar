<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FOOTSTEP-ALT | Ankle Exercise Counter (Human-in-the-Loop)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
html,body{
  margin:0; padding:0; overflow:hidden;
  background:#000; color:#fff; font-family:sans-serif;
}
video,canvas{
  position:absolute; top:0; left:0;
  width:100%; height:100%; object-fit:cover;
}
#titleBar{
  position:fixed; top:0; left:0; right:0;
  background:rgba(0,0,0,0.7);
  padding:8px; text-align:center;
}
#panel{
  position:fixed; bottom:0; left:0; right:0;
  background:rgba(0,0,0,0.75);
  padding:10px;
}
button{
  font-size:16px; padding:6px 12px; margin:4px;
}
#hud{
  font-size:12px; opacity:0.85;
  display:none;
}
</style>
</head>

<body>

<div id="titleBar">
  <b>FOOTSTEP-ALT</b><br>
  <small>Human-in-the-Loop Ankle Exercise Counter</small>
</div>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="panel">
  <button id="startBtn">▶ カメラ開始</button>
  <button id="hudBtn">HUD</button><br>
  足：<span id="side">LEFT</span>　
  左：<span id="leftCount">0</span>　
  右：<span id="rightCount">0</span>
  <div id="hud"></div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let model;
let running = false;

let lastSize = null;
let phase = "BACK";
let currentSide = "LEFT";
let leftCount = 0;
let rightCount = 0;
let hudOn = false;

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}
  });
  video.srcObject = stream;
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  model = await cocoSsd.load();
  running = true;
  detect();
}

function getFootSize(person){
  const [x,y,w,h] = person.bbox;
  return h * 0.33; // 下1/3を足とみなす
}

async function detect(){
  if(!running) return;

  const preds = await model.detect(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const person = preds.find(p=>p.class==="person");
  if(person){
    const size = getFootSize(person);

    if(lastSize !== null){
      if(phase==="BACK" && size > lastSize * 1.15){
        phase="FRONT";
      }
      else if(phase==="FRONT" && size < lastSize * 0.9){
        phase="BACK";
        if(currentSide==="LEFT"){
          leftCount++; currentSide="RIGHT";
        }else{
          rightCount++; currentSide="LEFT";
        }
      }
    }
    lastSize = size;

    if(hudOn){
      document.getElementById("hud").innerHTML =
        `bboxH:${person.bbox[3].toFixed(1)}<br>`+
        `footSize:${size.toFixed(1)}<br>`+
        `phase:${phase}`;
    }
  }

  document.getElementById("side").textContent = currentSide;
  document.getElementById("leftCount").textContent = leftCount;
  document.getElementById("rightCount").textContent = rightCount;

  requestAnimationFrame(detect);
}

document.getElementById("startBtn").onclick = ()=>{
  if(!running) startCamera();
};

document.getElementById("hudBtn").onclick = ()=>{
  hudOn = !hudOn;
  document.getElementById("hud").style.display = hudOn ? "block" : "none";
};
</script>

</body>
</html>
